rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // === ì‚¬ìš©ìë³„ ë°ì´í„° (êµì‚¬) ===
    match /users/{userId} {
      // ë³¸ì¸ ë¬¸ì„œë§Œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // ì¢…ëª© ì»¬ë ‰ì…˜
      match /events/{eventId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // í•™ê¸‰ ì»¬ë ‰ì…˜
      match /classes/{classId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // í•™ë…„ ì„¤ì • ì»¬ë ‰ì…˜
      match /gradeConfigs/{configId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // ğŸ†• Records ì»¬ë ‰ì…˜ (Phase 2)
      match /records/{recordId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // === ëŒ€íšŒ ì •ë³´ ===
    match /competitions/{competitionId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == resource.data.createdBy;
      allow create: if request.auth != null;
    }

    // === êµì‚¬ ì„¤ì • ===
    match /teacherSettings/{teacherId} {
      allow read, write: if request.auth != null && request.auth.uid == teacherId;
    }

    // === ê°œì¸ì •ë³´ ë™ì˜ ===
    match /privacy_consents/{consentId} {
      allow read, write: if request.auth != null;
    }

    // === ğŸ†• AccessCodes ì»¬ë ‰ì…˜ (Phase 2) ===
    // í•™ìƒ í˜ì´ì§€ìš© - ì½”ë“œë§Œ ì•Œë©´ ì¡°íšŒ ê°€ëŠ¥ (ì¸ì¦ ì—†ì´)
    match /accessCodes/{code} {
      allow read: if true;  // ê³µê°œ ì½ê¸° (í•™ìƒ í˜ì´ì§€ìš©)
      allow write: if request.auth != null;  // êµì‚¬ë§Œ ìƒì„±/ìˆ˜ì • ê°€ëŠ¥
    }

    // === ê¸°ì¡´ ì—°ìŠµ ê¸°ë¡ (í˜¸í™˜ì„± ìœ ì§€) ===
    match /competitions/{competitionId}/grades/{gradeId}/practiceRecords/{recordId} {
      allow read, write: if request.auth != null;
    }

    match /competitions/{competitionId}/grades/{gradeId}/classStats/{eventId} {
      allow read, write: if request.auth != null;
    }

    // === ê¸°ì¡´ í•™ê¸‰ (í˜¸í™˜ì„± ìœ ì§€) ===
    match /classes/{classId} {
      allow read, write: if request.auth != null;
    }
  }
}
