rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // 인증된 사용자만 읽기/쓰기 가능
    match /competitions/{compId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth.uid == resource.data.createdBy;

      // 학년별 데이터
      match /grades/{gradeId} {
        allow read, write: if request.auth != null;

        // 학급 데이터
        match /classes/{classId} {
          allow read, write: if request.auth != null;
        }

        // 연습 기록
        match /practiceRecords/{recordId} {
          allow read, write: if request.auth != null;
        }
      }
    }

    match /events/{eventId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    match /classes/{classId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      // results, totalScore, updatedAt 필드만 수정 허용
      allow update: if request.auth != null &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['results', 'totalScore', 'updatedAt', 'students']);
      allow delete: if request.auth != null;
    }

    match /gradeConfigs/{configId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // 개인정보 처리 동의 기록
    match /privacy_consents/{consentId} {
      // 자신의 동의 기록만 읽기 가능
      allow read: if request.auth != null &&
                     consentId.matches('^' + request.auth.uid + '_.*');
      // 자신의 동의 기록만 생성/수정 가능
      allow create, update: if request.auth != null &&
                               consentId.matches('^' + request.auth.uid + '_.*') &&
                               request.resource.data.teacherId == request.auth.uid;
      // 삭제는 불가
      allow delete: if false;
    }
  }
}
